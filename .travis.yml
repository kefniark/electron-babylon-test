os: osx
osx_image: xcode9.3
language: node_js
node_js: "10"
env:
  - ELECTRON_CACHE=$HOME/.cache/electron
  - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder

cache:
  directories:
  - node_modules
  - app/node_modules
  - $HOME/.cache/electron
  - $HOME/.cache/electron-builder

before_cache:
  - rm -rf $HOME/.cache/electron-builder/wine

stages:
  - test
  - name: build
    if: branch = master

jobs:
  include:
    - stage: install
      script:
        - npm install
        - npm run build
    - stage: test
      script: npm run test
    - stage: compile
      script:
        - npm run package-linux-mac
    - stage: deploy
      before_deploy:
      # Set up git user name and tag this commit
      - git config --local user.name "Travis CI"
      - git config --local user.email "ci@test.com"
      - git tag "$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)"
      deploy:
        provider: releases
        api_key: $GITHUB_OAUTH_TOKEN
        skip_cleanup: true

branches:
  except:
    - "/^v\\d+\\.\\d+\\.\\d+$/"